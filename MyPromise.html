<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      class MyPromise {
        // 构造方法
        constructor(executor) {
          // 初始化值
          this._initValue();
          // 执行传进来的函数
          executor(this.resolve.bind(this), this.reject.bind(this));
        }

        //私有方法
        _initValue() {
          // 初始化值
          this.promiseState = 'pending'; // 状态
          this.promiseResult = null; // 终值
          this.fullfilledCbs = [];
          this.rejectedCbs = [];
        }

        resolve(value) {
          if (this.promiseState === 'pending') {
            // 如果执行resolve，状态变为fulfilled
            this.promiseState = 'fulfilled';
            // 终值为传进来的值
            this.promiseResult = value;
            this.fullfilledCbs.forEach(item => {
              item(value);
            });
          }
        }

        reject(reason) {
          console.log('reject this.promiseState:', this.promiseState);
          if (this.promiseState === 'pending') {
            // 如果执行reject，状态变为rejected
            this.promiseState = 'rejected';
            // 终值为传进来的reason
            this.promiseResult = reason;
            this.rejectedCbs.forEach(item => {
              item(reason);
            });
          }
        }

        then(onFullfilled, onRejected) {
          if (this.promiseState === 'pending') {
            if (onFullfilled) {
              this.fullfilledCbs.push(onFullfilled);
            }
            if (onRejected) {
              this.rejectedCbs.push(onRejected);
            }
          }
          if (this.promiseState === 'fulfilled') {
            onFullfilled(this.promiseResult);
          }
          if (this.promiseState === 'rejected') {
            onRejected(this.promiseResult);
          }
        }
      }

      const p1 = new MyPromise((resolve, reject) => {
        setTimeout(() => {
          resolve('hello');
        }, 2000);
      });
      console.log('p1:', p1);

      p1.then(res => {
        console.log('res:', res);
      });
    </script>
  </body>
</html>
